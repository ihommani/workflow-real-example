name: Terraform root module application
run-name: '${{ github.actor }} run Terraform code apply'

on:
    workflow_call:
        inputs:
            environment:
                description: Targeted environment for infrastructure deployment
                type: string
                required: true
            root-module-path:
                description: Path of the terraform root module to apply linting on
                type: string
                required: true
            terraform-version:
                description: Terraform version to install
                required: true
                type: string

jobs:

    terraform-apply:
        environment: 
          name: ${{ inputs.environment }}
        runs-on: ubuntu-22.04
        defaults:
            run:
                working-directory: ${{ inputs.root-module-path }}
        permissions: 
            pull-requests: write
            contents: read
            id-token: write
        steps:


            #TODO: get body input containing the plan, kick report and cost
            # - uses: trstringer/manual-approval@v1
            #   with:
            #     secret: ${{ github.TOKEN }}
            #     approvers: user1,user2,org-team1
            #     minimum-approvals: 1
            #     issue-title: "Deploying infrastructure to prod from ${{ inputs.environment }}"
            #     issue-body: "Please approve or deny the deployment of version v1.3.5."
            #     exclude-workflow-initiator-as-approver: false
            #     additional-approved-words: ''
            #     additional-denied-words: ''

            - uses: actions/checkout@v4

            - uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ inputs.terraform-version }}

            - name: Authenticate to gcp workload identity pool
              id: auth_to_google
              uses: 'google-github-actions/auth@v2'
              with:
                  workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ vars.SA_TO_IMPERSONATE }}
                  create_credentials_file: true 
                
            - name: Terraform init
              id: init
              run: terraform init

            - name: Terraform validate
              id: validate
              run: terraform validate -no-color
            
            - name: Terraform apply
              id: apply
              run: terraform apply -auto-approve
              continue-on-error: false
