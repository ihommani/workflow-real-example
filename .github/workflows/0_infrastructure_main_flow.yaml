name: Infrastructure integration and deployment
run-name: '${{ github.actor }} triggered Infrastructure workflow'

on:
    push:
        paths: 
            - infrastructure/**.tf
    pull_request: 
        branches:
            - main
        paths: 
            - infrastructure/**.tf

jobs:

    infrastructure_integration:
        uses: ./.github/workflows/infrastructure_integration.yaml


    check_infrastructure_source_changes:
        if: github.event_name == 'pull_request'
        needs: infrastructure_integration
        uses: ./.github/workflows/_check_source_changes.yaml
        with:
          files: |
            **/*.tf
          get_folders: true


    infrastructure_plan:
        if: github.event_name == 'pull_request'
        needs: check_infrastructure_source_changes
        uses: ./.github/workflows/infrastructure_plan.yaml
        permissions: 
            pull-requests: write
            contents: read
            id-token: write
        strategy:
            fail-fast: false
            matrix:
              root_module_path: ${{ fromJSON(needs.check_infrastructure_source_changes.outputs.all_changed_files) }}
        with:
            root_module_path : ${{ matrix.root_module_path }}

    # TODO: if pull request, push the content of plan workflow output in the PR comment. Difficulty is we have a matrix job. We can't easily get the output
    # Maybe too complicated because we need to consume GHA artifact
        

    release: 
        if: github.ref_name == 'main'
        runs-on: ubuntu-22.04
        steps:

            - uses: googleapis/release-please-action@v4
              id: release
              with:
                token: ${{ github.token }}

            - uses: actions/checkout@v4
  
            - name: tag major and minor versions
              if: ${{ steps.release.outputs.release_created }}
              run: |
                  git config user.name github-actions[bot]
                  git config user.email 41898282+github-actions[bot]@users.noreply.github.com
                  git remote add gh-token "https://${{ secrets.GITHUB_TOKEN }}@github.com/googleapis/release-please-action.git"
                  git tag -d v${{ steps.release.outputs.major }} || true
                  git tag -d v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }} || true
                  git push origin :v${{ steps.release.outputs.major }} || true
                  git push origin :v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }} || true
                  git tag -a v${{ steps.release.outputs.major }} -m "Release v${{ steps.release.outputs.major }}"
                  git tag -a v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }} -m "Release v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}"
                  git push origin v${{ steps.release.outputs.major }}
                  git push origin v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}
