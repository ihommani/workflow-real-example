name: Terraform application integration
run-name: '${{ github.actor }} run Terraform code integration'

on:
    workflow_call:
        inputs:
            root-module-path:
                description: Path of the terraform root module to apply linting on
                type: string
                required: true
            terraform-version:
                description: Terraform version to install
                required: true
                type: string

jobs:
    terraform-basic-checks:
        runs-on: ubuntu-22.04
        defaults:
            run:
                working-directory: ${{ inputs.root-module-path }}
        permissions: 
            pull-requests: write
        steps:
            - uses: actions/checkout@v4

            - uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ inputs.terraform-version }}

            - name: Terraform fmt
              id: fmt
              run: terraform fmt -check
              continue-on-error: false

              # TODO: document web-app factory with this link: https://developer.hashicorp.com/terraform/language/modules/develop/composition

            - name: Authenticate to gcp workload identity pool
              id: auth_to_google
              uses: 'google-github-actions/auth@v2'
              with:
                  workload_identity_provider: https://developer.hashicorp.com/terraform/language/modules/develop/composition
                  service_account: workflow-real-example-gh@gde-ihommani.iam.gserviceaccount.com
                  token_format: access_token # maybe not needed. Try commented out. 
                  access_token_lifetime: 300s
                  create_credentials_file: true 

            - name: Terraform init
              id: init
              run: terraform init

            - name: Terraform validate
              id: validate
              run: terraform validate -no-color
            
    terraform_compliancy:
      needs: terraform-basic-checks
      runs-on: ubuntu-22.04
      defaults:
        run:
            working-directory: ${{ inputs.root-module-path }}
      steps:
        - uses: actions/checkout@v4
        # TODO: call checkmarks kicks
